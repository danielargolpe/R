---
title: "Trabajo final. Curso Análisis estadísticos multivariados con R"
author: "Andreoli, Gabriela; Fainburg, Leandro y Rodríguez Golpe, Daniela"
date: "2024-07-29"
output:
  html_document: default
  pdf_document: default
---
 
### Introducción

En este trabajo se analizaron datos provenientes de 152 lances del 2003 y 181 lances del 2005 de campañas de investigación realizadas por el INIDEP en el Distrito Bonaerense de la Provincia Biogeográfica Argentina (Menni, 1981), que abarca entre 34° y 43 °S. Dentro de este sistema se pueden diferenciar dos zonas: una zona costera estratificada ubicada al norte, influenciada por la descarga del Río de la Plata con profundidades menores a 50 m, al norte de los 38 °S y una zona costera homogénea, denominada El Rincón con profundidades menores a 50 m, al sur de los 38°S (Lucas et. al., 2005).
En las costas de la provincia de Buenos Aires las rayas típicas pertenecientes a la familia Rajidae, son los condríctios de mayor diversidad. Considerando las características ambientales como temperatura y salinidad se han determinado tres grupos de rayas: el grupo norbonaerense, el grupo surbonaerense y el grupo de amplia distribución (Menni y Gosztonyi, 1982; Anganuzzi, 1983; Menni y López, 1984; Díaz de Astarloa et al., 1999). Dentro de éste último, se encuentran las especies analizadas en este trabajo: *Atlantoraja castelnaui*, *Atlantoraja cyclophora*, *Sympterygia acuta*, *Sympterygia bonapartii* y *Rioraja agassizi*. Una característica que resalta entre estas especies es su capacidad para adaptarse a las diferentes condiciones ambientales de temperatura y salinidad (Diaz de Astarloa, 2016).


El **objetivo** de este trabajo fue analizar la distribución y abundancia de cinco especies de rayas del litoral bonaerense considerando dos variables ambientales 
(salinidad y temperatura) en los años 2003 y 2005. 


### Exploración del dataset

Se partió de un dataset con 333 observaciones y 17 variables. Las variables fueron: año, número de lance, latitud y longitud, profundidad inicial (m), temperatura de fondo (°C), salinidad de fondo (g/l), densidades y peso en kilos (Kg) de 5 especies de rayas 

```{r set knitr options, echo = FALSE}
# set some knitr options
knitr::opts_chunk$set(echo = TRUE
                      , message = FALSE
                      , warning = FALSE)
```

```{r}
rayas <- read.csv("C:/Backup compu/INIDEP/CURSOS/Análisis estadisticos multivariados con R/rayas.csv")
data(rayas)

#str(rayas)
```


```{r}
library(knitr)
library(magrittr)
data.frame(variable = names(rayas),
           clase = sapply(rayas, typeof),
           primeros_valores = sapply(rayas, function(x) paste0(head(x),  collapse = ", ")),
           row.names = NULL) %>% 
  kable()
```

Se analizaron  el primer cuartil, la mediana, la media, el tercer cuartil y los valores mínimos y máximos de todas las variables excepto AÑO, LANCE, LAT Y LONG.

```{r}
summary(rayas[,5:17])

```
  

A partir del análisis de la media (23,91 m) y los valores mínimos(2 m) y máximos (60 m) de la variable PROF_INIC, se decidió indagar en la desviación estándar y el coeficiente de variación de esta variable:


```{r}
prom_prof <- mean(rayas$PROF_INIC) 
print(paste("La media de PROF_INIC es:", round(prom_prof,2)))
desv_prof <- sd(rayas$PROF_INIC) 
print(paste("La desviación estándar de PROF_INIC es:", round(desv_prof,2)))
CV_prof <- (desv_prof/prom_prof)*100 
print(paste("El coeficiente de variación (CV) de PROF_INIC es:", round(CV_prof,2)))
```

Se detectó una media de profundidad inicial de 23,91 ± 13,48 m y un coeficiente de variación muy por encima del 25%, lo cual significó que los lances fueron realizados o bien a poca o a gran profundidad, siendo la media un valor no representativo de la profundidad inicial. Se decidió, por lo tanto, no tener en cuenta la variable PROF_INIC en los siguientes análisis de este trabajo.


Se realizó un scatterplot a fin de establecer posibles relaciones entre las variables

```{r}
pairs(rayas[,8:17])
```

Las comparaciones entre pares de variables a partir del scatterplot permitió observar una posible relación lineal entre la variable densidad y peso (kg) de cada especie. 
Se calcularon los coeficientes de correlación entre la variable densidad y peso (Kg) de cada especie

```{r}
cor(rayas[,8:17],use="complete.obs")
```

Se obtuvieron coefientes de correlación cercanos a 1 entre las variables densidad y peso(Kg) de cada especie. 
De esta forma, se consideró sólo la densidad para los análisis posteriores.

### Reordenamiento del dataset
A fin de realizar una búsqueda eficiente de outliers en las variables del dataset a partir de visualizaciones mediante boxplot, se transformó el dataset original para que cada observación estuviera representada en una fila. En cada observación se registró la densidad por especie por lance y se incorporó una nueva variable categórica (Especie). Asimismo, se eliminaron las variables peso(kg) de cada especie, por verificarse fuertemente correlacionada con la densidad; y profundidad, ya que mostraba valores poco confiables respecto a la zona de pesca. El dataset obtenido contenía 1665 observaciones y 7 variables: año, latitud, longitud, especie, densidad, salinidad y temperatura.

```{r}
Rayas_Edit <- read.csv("C:/Backup compu/INIDEP/CURSOS/Análisis estadisticos multivariados con R/Rayas_Edit.csv")
data(Rayas_Edit)
#str(Rayas_Edit)
```

```{r}
data.frame(variable = names(Rayas_Edit),
           clase = sapply(Rayas_Edit, typeof),
           primeros_valores = sapply(Rayas_Edit, function(x) paste0(head(x),  collapse = ", ")),
           row.names = NULL) %>% 
  kable()
```

### Limpieza de outliers

A partir de visualizaciones con boxplot se detectaron los valores atípicos y se realizó la limpieza de los mismos de las variables densidad, salinidad y temperatura.
Se consideraron outliers a aquellas observaciones del dataset que se encontraron excepcionalmente alejadas de la mayor parte de los datos.
En el caso de la densidad se encontraron valores atípicos en la especie *Sympterygia acuta* y se decidió eliminar aquellos valores de densidad mayores a 7
De la salinidad se consideraron valores atípicos aquellos menores o iguales a 31.5 g/l
No se encontraron valores atípicos de temperatura.

```{r}
library(ggplot2)
```

#### Se analizó la densidad por especie

```{r}
ggplot(Rayas_Edit,aes(x=Especie, y=Densidad, fill=Densidad))+
  geom_boxplot(alpha=0.4)+
  labs(x="Especie de raya", y="Densidad",
       title="Densidad por especie")+
  theme(legend.position="none")+
  theme(panel.background = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  theme(axis.line = element_line(color = "grey50",
                                 linewidth = 0.5,
                                 linetype = 1))
```

Se observaron valores de densidad de 0 a 5 para todas las especies. Se eliminaron del dataset los valores de densidad mayores a 7 que correspondían a *S. acuta*.

No se quitaron los valores de densidad igual a 0 por considerarse informativos
para comparaciones con variables ambientales, subset Rayas_Edit_ 

```{r}
Rayas_Edit_ <- subset(Rayas_Edit, Densidad<7)
head(Rayas_Edit_,6)
tail(Rayas_Edit_,6)
```

Se volvió a graficar sin valores atípicos la variable densidad

```{r}
ggplot(Rayas_Edit_,aes(x=Especie, y=Densidad, fill=Densidad))+
  geom_boxplot(alpha=0.4)+
  labs(x="Especie de raya", y="Densidad",
       title="Densidad por especie")+
  theme(legend.position="none")+
  theme(panel.background = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())+
  theme(axis.line = element_line(color = "grey50",
                                 linewidth = 0.5,
                                 linetype = 1))
```

Se realizó un histograma para observar las distribuciones de la variable densidad por especie. La mayor frecuencia se encontró en densidad igual a cero en todas las especies analizadas. La especie con mayores valores de densidad fue *S. acuta*. 

```{r}
ggplot(Rayas_Edit_,aes(x=Densidad, fill=Especie))+
  geom_histogram(binwith=30, position="identity", alpha=0.4)+
  labs(x="Densidad", y="Frecuencia",
       title="Densidad por especie")+
  facet_wrap(~Especie, scales="free")+
  scale_fill_manual(values = c("AtlanCast_DEN"="red", "AtlanCy_DEN"="yellow", "RioAg_DEN"="black", 
                               "SyBon_DEN"="orange", "SyAc_DEN"="blue"))+
  theme_minimal()+
  theme(legend.position = "none")
```

#### Se analizó la variable Temperatura

```{r}
with(Rayas_Edit_, boxplot(TMP_MAR_F, xlab="Temperatura de fondo"))
```

Se observó que los valores de temperatura rondan entre los 14 y 18 °C para la mayoría de las observaciones. No se encontraron valores atípicos de temperatura.

#### Se analizó la salinidad

```{r}
with(Rayas_Edit_, boxplot(SAL_FONDO, xlab="Salinidad"))
```

Se observó que la salinidad ronda entre los 32 y 34 g/l.Se consideraron valores atípicos de salinidad a aquellos menores o iguales a 31.5 g/l. Se reemplazaron estos valores por NA con el objetivo de no perder estas observaciones del dataset en relación al resto de las variables analizadas.

```{r}
Rayas_Edit_$SAL_FONDO <- ifelse(Rayas_Edit_$SAL_FONDO<=31.5, NA, Rayas_Edit_$SAL_FONDO)
```

```{r}
with(Rayas_Edit_, boxplot(SAL_FONDO, xlab="Salinidad"))
```

Una vez eliminados los valores atípicos se calculó el desvío estándar, la media y el coeficiente de variación (CV) de la salinidad y la temperatura.

```{r}
desv_sal <- sd(Rayas_Edit_$SAL_FONDO, na.rm=TRUE) 
#print(paste("El desvío estándar de SAL_FONDO es:", round(desv_sal,2)))
prom_sal <- mean(Rayas_Edit_$SAL_FONDO, na.rm=TRUE) 
#print(paste("La media de SAL_FONDO es:", round(prom_sal,2)))
CV_sal <- (desv_sal/prom_sal)*100 
#print(paste("El CV de SAL_FONDO es:", round(CV_sal,2)))
```

```{r}
desv_temp <- sd(Rayas_Edit_$TMP_MAR_F, na.rm=TRUE) 
#print(paste("El desvío estándar de TMP_MAR_F es:", round(desv_temp,2)))
prom_temp <- mean(Rayas_Edit_$TMP_MAR_F, na.rm=TRUE) 
#print(paste("La media de TMP_MAR_F es:", round(prom_temp,2)))
CV_temp <- (desv_temp/prom_temp)*100 
#print(paste("El CV de TMP_MAR_F es:", round(CV_temp,2)))
```

```{r}
tab <- matrix (c (prom_sal,desv_sal, CV_sal, prom_temp, desv_temp, CV_temp), ncol = 3 , byrow = TRUE) 
colnames (tab) <- c ("Media", "Desvio_estandar","CV") 
rownames (tab) <- c ("Salinidad","Temperatura") 
tab <- as.table (tab)
print(tab)
```

```{r}
pairs(Rayas_Edit_[,5:7])
```

No se observaron posibles relaciones lineales entre las variables analizadas. Se observó gran cantidad de valores de densidad de especies iguales o cercanos a 0, lo cual podría repercutir en el análisis estadístico realizado.  

```{r}
library(lattice)
```

```{r}
color_especie <- c("AtlanCast_DEN"="red", "AtlanCy_DEN"="yellow", "RioAg_DEN"="black", 
                         "SyBon_DEN"="orange", "SyAc_DEN"="blue")

trellis_3d_plot <- cloud(SAL_FONDO~TMP_MAR_F * Densidad | Especie,
                        data=Rayas_Edit_, 
                        groups=Especie,
                        col=color_especie,
                        main="Relación entre variables ambientales y densidad de especies de raya",
                        xlab="Salinidad",
                        ylab="Densidad",
                        zlab="Temperatura") 
                        
                        
print(trellis_3d_plot)
```

Se observó una gran cantidad de datos que se agruparon a densidad 0, sin embargo las observaciones de densidad distintas a 0 mostraron distrubuciones en los mismos rangos de salinidad y temperatura en todas las especies analizadas.

Se graficaron las posiciones de los lances a fin de poder visualizar la cobertura del área de muestreo por año.

```{r}
ggplot(rayas, aes(LONG,LAT)) + 
  geom_point(aes(color=factor(YEAR))) +
  facet_wrap(~factor(YEAR))
```

Se observó que los lances se distribuyeron en posiciones similares en los años 2003 y 2005, con mayor número de lances en este último.
A latitud 38°S, zona que divide la región norbonaerse de la surbonaerense, se registraron menor número de lances en ambos años. 

Se graficó la densidad de cada especie según latitud y longitud sin diferenciar por año, ya que se observó que la posición de los lances fue similar tanto en 2003 como en 2005. No se graficaron las densidades iguales a 0.

```{r}
ggplot(Rayas_Edit_, aes(LONG,LAT)) +
  geom_point(aes(size=ifelse(Densidad==0, NA, Densidad))) +
  facet_wrap(~Especie)
```

*Atlantoraja castelnaui* y *Sympterygia acuta* fueron las especies de mayor densidad tanto en la zona norte como en la zona de El Rincón. Para todas las especies se observaron bajas densidades en las cercanías de los 38°S.


Densidad de cada especie según salinidad y temperatura. 
No se graficaron las densidades iguales a 0.

```{r}
ggplot(Rayas_Edit_, aes(SAL_FONDO,TMP_MAR_F)) +
  geom_point(aes(size=ifelse(Densidad==0, NA, Densidad))) +
  facet_wrap(~Especie)
```

Las dos figuras anteriores muestran que las cinco especies evaluadas se encuentran representadas en la zona muestreada y en condiciones ambientales similares.

### Modelización del ambiente

Para analizar la interrelación entre las especies y las variables ambientales, se trabajó con un dataset en el que las observaciones estaban dadas por los lances por año (333 observaciones y 10 variables)
Teniendo en cuenta el filtrado de las variables que se realizó en la sección anterior, se utilizaron los mismos criterios para la eliminación de outliers de cada variable.
En particular, se quitaron las densidades mayores o iguales a 8
y se mantuvieron los valores de densidad igual a 0, por considerarse informativos
para comparaciones con variables ambientales (subset Rayas_full_edit_).

```{r}
Rayas_full <- read.csv("C:/Backup compu/INIDEP/CURSOS/Análisis estadisticos multivariados con R/Rayas_full.csv")
#data(Rayas_full)

```

```{r}
data.frame(variable = names(Rayas_full),
           clase = sapply(Rayas_full, typeof),
           primeros_valores = sapply(Rayas_full, function(x) paste0(head(x),  collapse = ", ")),
           row.names = NULL) %>% 
  kable()
```

```{r}
summary(Rayas_full[,4:10])
```


```{r}
Rayas_full_edit_ <- Rayas_full
Rayas_full_edit_[,6:10] <- apply(Rayas_full_edit_[,6:10], 2, function(x) ifelse(x>=8,NA,x))
```

Se filtraron las salinidades menores o iguales a 31.5 g/l

```{r}
Rayas_full_edit_$SAL_FONDO <- ifelse(Rayas_full_edit_$SAL_FONDO<=31.5, NA, Rayas_full_edit_$SAL_FONDO)
```

Para analizar las variaciones interanuales, se generaron dos subsets: uno para el año 2003 y otro para el 2005.

```{r}
rayas_full_2003 <- subset(Rayas_full_edit_, AÑO=="2003")
```

```{r}
rayas_full_2005 <- subset(Rayas_full_edit_, AÑO=="2005")
```

Se calculó el KMO para las variables del año 2003 y del 2005, para evaluar la idoneidad de los datos para un análisis de componentes principales (PCA).

```{r}
library(psych)
```

```{r}
KMO(rayas_full_2003[,c(4:10)])
```

Para el año 2003, se observó que el KMO resultó menor a 0,5 para la mayoría de las variables, por lo cual, no sería idóneo para realizar un PCA.

```{r}
KMO(rayas_full_2005[,c(4:10)])
```

El KMO para el año 2005 resultó mayor a 0,5 para casi todas las variables.
Por lo tanto, se eligió este año para realizar el PCA.


**Análisis de Componentes Principales**

```{r}
library(FactoMineR)
```

```{r}
rayaspca<-PCA(rayas_full_2005[,4:10], scale.unit =TRUE, ncp = 5,graph=FALSE)
```

```{r}
library(factoextra)
library(gridExtra)
```

```{r}
gr1<-fviz_pca_var(rayaspca, axes=c(1,2),col.var = "contrib",
                  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),repel = TRUE)+
  ggtitle("Cent_variables")
gr2<-fviz_pca_ind(rayaspca, axes=c(1,2),col.ind="contrib",
                  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),repel =FALSE)+
  ggtitle("Cent_indiv")
grid.arrange(gr1, gr2, ncol = 2)
```

El eje 1 explica el 27,1% de la variabilidad y el eje 2 el 24,7%, lo que acumula un total de 51,8%, que se considera adecuado para su representación gráfica.Las variables densidad de las cinco especies de raya y temperatura se encontraron bien representadas. Las mayores contribuciones (mayores al 15%) estuvieron dadas por la densidad de *S. acuta*, *S.bonapartii* y *A. cyclophora*, mientras que *R.agassizi* y *A.castelnaui* y la variable temperatura realizaron un menor aporte a los ejes.Por otra parte, se observó que la salinidad tiene una contribución muy baja, menor al 5%.   
Las variables ambientales aportan al eje 2 en sentidos opuestos, es decir, la salinidad aporta al cuadrante negativo y la temperatura aporta al cuadrante positivo.Las especies de raya aportan a ambos ejes pero se encuentran en valores positivos del eje 1.
Se observó que gran parte de los lances representados presentaron densidad 0. El valor 176 correspondió a un lance en donde se observaron altas densidades de las especies *S. bonapartii* y *S. acuta* mientras que el valor 170 correspondió a un lance en donde el mayor aporte de densidad, estuvo dado por 
*A. cyclophora* y *R. agassizi*.


### Conclusiones

En las campañas analizadas correspondientes a los años 2003 y 2005 las cinco especies de rayas: *Atlantoraja cyclophora*, *Atlantoraja castelnaui*, *Sympterygia acuta*, *Sympterygia bonapartii* y *Rioraja agassizi* se encontraron representadas en la zona muestreada y en condiciones ambientales similares (salinidad y temperatura). *Atlantoraja castelnaui* y *Sympterygia acuta* fueron las especies de mayor densidad en la zona de influencia del Río de la Plata, al norte del 38°S. como en la zona de El Rincón. Para todas las especies se observaron bajas o nulas densidades en las cercanías de los 38°S que coincide con una baja cantidad de lances en esa zona. En relación a la distribución.
En relación a los lances realizados en el 2005, el análisis de componentes principales evidencia que las variables ambientales aportaron a la variabilidad en un único eje (eje 2), mientras que las especies de rayas estudiadas tuvieron aportes a los dos ejes (eje 1 y eje 2).
Los resultados de este análisis se encuentran en concordancia con lo reportado hasta el momento para estas especies (ver Díaz de Astarloa, 2016), que poseen gran capacidad para adaptarse a las dintintas condiciones ambientales de temperatura y salinidad.

### Referencias bibliográficas

- Anganuzzi, A. 1983. Estructura de la comunidad de peces del área costera bonaerense. Tesis de Grado, Facultad de Ciencias Exactas y Naturales, Universidad Nacional de Mar del Plata, pp.1-60.

- Díaz de Astarloa, J. M., A. Aubone y M. B. Cousseau. 1999. Asociaciones ícticas de la plataforma costera de Uruguay y norte de Argentina, y su relación con los parámetros ambientales. Physis, Secc. A 57(132-133): 29-45.

- Díaz de Astarloa J.M. 2016. Peces marinos de la costa bonaerense; Fundación de Historia Natural Félix de Azara; 399-431.

- Lucas A. J., R. A. Guerrero, H. W. Mianzan, E. M. Acha y C. A. Lasta. 2005. Coastal oceanographic regimes of the Northern Argentine Continental Shelf (34º-43ºS). Estuarine, Coastal and Shelf Science 65: 405-420.
 
- Menni R. C. 1981. Sobre la distribución de los peces marinos de la Argentina. Symposia, VI Jornadas de Zoología, La Plata, Argentina, 53-73 p.

- Menni, R. C. y A. E. Gosztonyi. 1982. Benthic and semidemersal fish association in the Argentine Sea. Studies of Neotropical Fauna and Environment, 17: 1-29.

- Menni, R. C. y H. L. López. 1984. Distributional patterns of Argentine marine fishes. Physis, Secc. A, 42(103): 71-85


























  













